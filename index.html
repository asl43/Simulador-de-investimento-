<!doctype html>
<html lang="pt-BR" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Simulador Avan√ßado de Investimentos ‚Äî IR e Proje√ß√µes</title>
  <style>
    /* VARI√ÅVEIS DE TEMA - DARK MODE (Padr√£o) */
    :root{
      --bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8;--glass:rgba(255,255,255,0.03);--success:#10b981;--warning:#f59e0b;--danger:#ef4444;--text:#e6eef6;--subtle-border:rgba(255,255,255,0.05);--input-bg:#071428;--header-bg:linear-gradient(180deg,#071023 0%, #0f1724 100%);--shadow:0 6px 18px rgba(2,6,23,0.6);--secondary-text:#cbd5e1;--highlight-bg:rgba(6,182,212,0.1);--table-header-bg:rgba(6,182,212,0.1);--table-header-border:rgba(6,182,212,0.3);
    }
    
    /* VARI√ÅVEIS DE TEMA - LIGHT MODE */
    [data-theme="light"] {
      --bg:#f8fafc;--card:#ffffff;--accent:#1d4ed8;--muted:#64748b;--glass:rgba(0,0,0,0.03);--success:#059669;--warning:#d97706;--danger:#dc2626;--text:#1e293b;--subtle-border:rgba(0,0,0,0.1);--input-bg:#f1f5f9;--header-bg:linear-gradient(180deg,#dbeafe 0%, #f8fafc 100%);--shadow:0 4px 12px rgba(30,41,59,0.1);--secondary-text:#334155;--highlight-bg:rgba(29,78,216,0.1);--table-header-bg:rgba(29,78,216,0.1);--table-header-border:rgba(29,78,216,0.3);
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--header-bg);color:var(--text);padding:20px;line-height:1.6;transition:background-color 0.3s, color 0.3s}
    .container{max-width:1200px;margin:0 auto}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px}
    h1{font-size:22px;font-weight:700;color:var(--accent)}
    h2{font-size:18px;margin-bottom:12px;color:var(--text)}
    h3{font-size:16px;margin-bottom:10px;color:var(--secondary-text)}
    .card{background:var(--glass);border-radius:12px;padding:18px;margin-bottom:16px;box-shadow:var(--shadow);border:1px solid var(--subtle-border)}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px;font-weight:500}
    input,select{width:100%;padding:10px;border-radius:8px;border:1px solid var(--subtle-border);background:var(--input-bg);color:var(--text);font-size:14px;transition:border-color 0.2s, background-color 0.2s}
    input:focus,select:focus{outline:none;border-color:var(--accent)}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:18px}
    .controls{display:grid;gap:12px}
    .row{display:flex;gap:10px;align-items:end}
    button{background:var(--accent);border:none;padding:11px 16px;border-radius:10px;color:var(--bg);cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s}
    button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(6,182,212,0.3);filter:brightness(1.1)}
    [data-theme="light"] button:hover{box-shadow:0 4px 12px rgba(29,78,216,0.3)}
    button:active{transform:translateY(0)}
    .small-btn{background:var(--glass);border:none;padding:5px 10px;border-radius:6px;cursor:pointer;font-size:14px;color:var(--text)}
    .small-btn:hover{background:rgba(255,255,255,0.2)}
    [data-theme="light"] .small-btn:hover{background:rgba(0,0,0,0.1)}
    table{width:100%;border-collapse:collapse;margin-top:10px;font-size:13px}
    th{background:var(--table-header-bg);padding:10px 8px;text-align:left;font-weight:600;color:var(--accent);border-bottom:2px solid var(--table-header-border);position:sticky;top:0;z-index:10}
    td{padding:10px 8px;border-bottom:1px solid var(--subtle-border)}
    tr:hover{background:var(--glass)}
    .muted{color:var(--muted);font-size:13px}
    .small{font-size:12px}
    .right{text-align:right}
    .actions{display:flex;gap:8px;flex-wrap:wrap}
    .chart-wrap{background:linear-gradient(180deg,var(--glass),transparent);padding:14px;border-radius:8px;margin-top:10px;position:relative}
    .footer{font-size:13px;color:var(--muted);margin-top:16px;text-align:center;padding-top:16px;border-top:1px solid var(--subtle-border)}
    .badge{padding:3px 8px;background:rgba(6,182,212,0.2);border-radius:5px;font-size:11px;font-weight:600;display:inline-block}
    [data-theme="light"] .badge{background:rgba(29,78,216,0.2)}
    /* Dashboard de Carteira e Proje√ß√£o */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin-top:12px}
    .stat-card{background:rgba(6,182,212,0.05);padding:12px;border-radius:8px;border-left:3px solid var(--accent)}
    [data-theme="light"] .stat-card{background:rgba(29,78,216,0.05)}
    .stat-value{font-size:18px;font-weight:700;color:var(--text);margin-top:4px}
    .tabs{display:flex;gap:8px;margin-bottom:12px;border-bottom:2px solid var(--subtle-border)}
    .tab{padding:10px 16px;cursor:pointer;border-bottom:2px solid transparent;margin-bottom:-2px;font-weight:500;color:var(--muted);transition:all 0.2s}
    .tab:hover{color:var(--text)}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .projection-table{font-size:12px;max-height:400px;overflow-y:auto}
    .highlight{background:rgba(16,185,129,0.1);font-weight:600}
    .ir-warning{color:var(--danger);font-weight:600}
    .ir-exempt{color:var(--success);font-weight:600}
    .bar-chart-container{height:200px}
    /* Estilo para cards de categorias */
    .category-stats-grid{
        display:grid;
        grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
        gap:10px;
        margin-top:10px;
        padding:10px;
        background:var(--input-bg);
        border-radius:8px;
        border:1px solid var(--subtle-border);
    }
    .category-stat-card{
        padding:10px;
        border-radius:6px;
        background:var(--card);
        border-left:3px solid var(--accent);
    }
    .category-stat-card .stat-value{font-size:16px;}
    .category-stat-card .muted{font-size:11px;}
    .category-stat-card.external-yield{border-left-color: #8b5cf6;}
    .category-stat-card.total-yield{border-left-color: var(--success); background:var(--highlight-bg);}


    #themeToggle{width:auto;margin-left:10px;padding:8px 12px;background:var(--card);color:var(--text);border:1px solid var(--subtle-border)}
    #themeToggle:hover{filter:none;transform:none;background:var(--glass)}

    @media (max-width:920px){.grid{grid-template-columns:1fr}.stats-grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:600px){.category-stats-grid{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>üìä Simulador Avan√ßado de Investimentos</h1>
        <div class="muted">Com c√°lculo de IR (regressivo), taxas e proje√ß√£o detalhada</div>
      </div>
      <button id="themeToggle">üåì Alternar Tema</button>
    </header>

    <div class="grid">
      <div>
        <section class="card">
          <h3 id="assetFormTitle">‚ûï Adicionar Ativo / Fundo</h3>
          <div class="controls">
            <div class="row">
              <div style="flex:2">
                <label>S√≠mbolo (ex: RZAG11)</label>
                <input id="symbol" placeholder="RZAG11" />
              </div>
              <div style="flex:1">
                <label>Quantidade</label>
                <input id="qty" type="number" min="1" step="1" value="1" />
              </div>
              <div style="flex:1">
                <label>Data de Aquisi√ß√£o</label>
                <input id="purchaseDate" type="date" value="2024-01-01" />
              </div>
            </div>
            <div class="row">
              <div style="flex:1">
                <label>Pre√ßo por cota (R$)</label>
                <input id="price" type="number" min="0.01" step="0.01" value="10.00" />
              </div>
              <div style="flex:1">
                <label>Yield anual (%)</label>
                <input id="yield" type="number" min="0" step="0.01" value="10.00" />
              </div>
              <div style="flex:1">
                <label>Categoria</label>
                <select id="category">
                  <option value="FII">FII (Provento Isento)</option>
                  <option value="A√ß√µes">A√ß√µes (Provento Isento/Ganhos Tribut√°veis)</option>
                  <option value="Renda Fixa">Renda Fixa (Tributa√ß√£o Regressiva)</option>
                  <option value="ETF">ETF (Provento/Ganhos Tribut√°veis)</option>
                  <option value="Criptomoedas">Criptomoedas</option>
                  <option value="Outros">Outros</option>
                </select>
              </div>
            </div>
            
            <div id="irOptions">
              <div class="row" id="rfDurationRow" style="display:none;">
                <div style="flex:1">
                  <label>Dura√ß√£o (dias) - Para Renda Fixa</label>
                  <input id="daysHeld" type="number" min="1" value="721" placeholder="Ex: 721 dias para 15%" />
                </div>
              </div>
              <div id="isExemptRow">
                <label><input type="checkbox" id="irExempt" /> Marcar como Isento de IR (Anula regras autom√°ticas)</label>
              </div>
            </div>
            
            <div class="row">
              <button id="addBtn">‚ûï Adicionar Ativo</button>
              <button id="updateBtn" style="background:var(--success); display:none;">‚úèÔ∏è Atualizar Ativo</button>
              <button id="presetBtn" style="background:#8b5cf6">üéØ Presets (FIIs)</button>
              <button id="clearBtn" style="background:#ef4444">üóëÔ∏è Limpar Carteira</button>
            </div>
          </div>
        </section>

        <section class="card">
          <h3>üí∞ Gerenciar Rendas Recorrentes (Monetiza√ß√£o)</h3>
          <div class="controls">
            <div class="row">
                <div style="flex:1.5">
                    <label>Tipo de Renda</label>
                    <select id="recurrentIncomeType">
                        <option value="Kwai">Monetiza√ß√£o Kwai/TikTok</option>
                        <option value="99Pay">Rendimento 99Pay/Mercado Pago</option>
                        <option value="Outra">Outra Renda Mensal L√≠quida</option>
                    </select>
                </div>
                <div style="flex:1">
                    <label>Valor Mensal (R$)</label>
                    <input type="number" id="recurrentMonthlyValue" min="0" step="10" value="50.00" />
                </div>
                <div style="flex:1">
                    <label>IR Al√≠quota (%) (apenas para 99Pay)</label>
                    <input type="number" id="recurrentIrRate" min="0" max="100" step="1" value="20" />
                </div>
                <button id="addRecurrentBtn" style="width:auto; margin-top: 10px;">‚ûï Adicionar Renda</button>
            </div>
            <div style="overflow-x:auto; margin-top:10px;">
                <table id="recurrentIncomeTable">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th class="right">Valor Mensal</th>
                            <th class="right">IR (%)</th>
                            <th class="right">L√≠quido Anual</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="totalRecurrentIncome" style="margin-top:10px; font-weight:600;"></div>
          </div>
        </section>


        <section class="card">
          <h3>üíº Carteira de Investimentos</h3>
          <div style="margin-bottom:10px">
            <label>Filtrar por categoria:</label>
            <select id="filterCategory">
              <option value="">Todas as categorias</option>
              <option value="FII">FII</option>
              <option value="A√ß√µes">A√ß√µes</option>
              <option value="Renda Fixa">Renda Fixa</option>
              <option value="ETF">ETF</option>
              <option value="Criptomoedas">Criptomoedas</option>
              <option value="Outros">Outros</option>
            </select>
          </div>
          <div style="overflow-x:auto">
            <table id="assetsTable">
              <thead>
                <tr>
                  <th>Ativo</th>
                  <th>Categoria</th>
                  <th class="right">Qtd</th>
                  <th class="right">Data Aquisi√ß√£o</th>
                  <th class="right">Investido</th>
                  <th class="right">%</th>
                  <th class="right">Yield</th>
                  <th class="right">Provento/ano</th>
                  <th class="right">IR Est.</th>
                  <th>A√ß√µes</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>

          <div class="stats-grid">
            <div class="stat-card">
              <div class="muted small">Total Investido</div>
              <div class="stat-value" id="totalInvest">R$ 0,00</div>
            </div>
            <div class="stat-card">
              <div class="muted small">Proventos Brutos/Ano</div>
              <div class="stat-value" id="totalYield">R$ 0,00</div>
            </div>
            <div class="stat-card">
              <div class="muted small">IR Anual Estimado</div>
              <div class="stat-value" id="totalIR">R$ 0,00</div>
            </div>
            <div class="stat-card">
              <div class="muted small">L√≠quido/Ano (Apenas Ativos)</div>
              <div class="stat-value" id="netYield">R$ 0,00</div>
            </div>
            <div class="stat-card">
              <div class="muted small">Yield L√≠q. M√©dio</div>
              <div class="stat-value" id="avgYield">0%</div>
            </div>
            <div class="stat-card">
              <div class="muted small">Total de Ativos</div>
              <div class="stat-value" id="totalAssets">0</div>
            </div>
          </div>

          <h3 style="margin-top:20px; border-bottom:1px solid var(--subtle-border); padding-bottom:5px;">Detalhe de Rendimentos L√≠quidos Anuais (Dashboard de Ganhos)</h3>
          <div id="categoryNetStats" class="category-stats-grid">
            </div>

          <div style="margin-top:14px" class="actions">
            <button id="saveBtn" style="background:#10b981">üíæ Salvar Carteira</button>
            <button id="exportBtn" style="background:#8b5cf6">üì§ Exportar CSV</button>
            <button id="importBtn" style="background:#3b82f6">üì• Importar CSV</button>
            <button id="resetStorage" style="background:#f59e0b">‚ö†Ô∏è Apagar Dados Salvos</button>
          </div>
          <input type="file" id="importFile" accept=".csv" style="display:none" />
        </section>
      </div>

      <aside>
        <section class="card">
          <h3>üéØ Configura√ß√£o da Simula√ß√£o</h3>
          <div class="controls">
            <div class="row">
              <div style="flex:1">
                <label>Horizonte (anos)</label>
                <select id="years">
                  <option value="1">1 ano</option>
                  <option value="3">3 anos</option>
                  <option value="5" selected>5 anos</option>
                  <option value="10">10 anos</option>
                  <option value="15">15 anos</option>
                  <option value="20">20 anos</option>
                </select>
              </div>
              <div style="flex:1">
                <label>Aporte mensal (R$)</label>
                <input type="number" id="monthlyContribution" min="0" step="100" value="500" />
              </div>
            </div>

            <div>
              <label><input type="checkbox" id="reinvest" checked/> Reinvestir proventos l√≠quidos (ativos + rendas recorrentes)</label>
            </div>
            <div>
              <label><input type="checkbox" id="considerInflation" /> Considerar infla√ß√£o (IPCA 4,5% a.a.)</label>
            </div>
          </div>
        </section>

        <section class="card">
          <h3>üìà Diversifica√ß√£o da Carteira</h3>
          <div class="chart-wrap">
            <canvas id="pieChart" width="360" height="220"></canvas>
          </div>
          <div id="categoryBreakdown" style="margin-top:12px;font-size:12px"></div>
        </section>


        <section class="card">
          <div class="tabs">
            <div class="tab active" onclick="switchTab('growth')">üìä Crescimento</div>
            <div class="tab" onclick="switchTab('monthly')">üìÖ Detalhes Mensais</div>
          </div>

          <div id="growth-tab" class="tab-content active">
            <h4 style="color:var(--text); margin-bottom:10px;">Totais Projetados (Ativos + Rendas Recorrentes)</h4>
            <div class="stats-grid" style="margin-bottom:15px; grid-template-columns:1fr 1fr 1fr">
              <div class="stat-card" style="border-left-color: var(--accent);">
                <div class="muted small">Proventos Brutos Totais</div>
                <div class="stat-value" id="projectedGrossYield">R$ 0,00</div>
              </div>
              <div class="stat-card" style="border-left-color: var(--danger);">
                <div class="muted small">IR Total Estimado</div>
                <div class="stat-value" id="projectedIRPaid">R$ 0,00</div>
              </div>
              <div class="stat-card" style="border-left-color: var(--success);">
                <div class="muted small">Proventos L√≠quidos Totais</div>
                <div class="stat-value" id="projectedNetYield">R$ 0,00</div>
              </div>
            </div>

            <div class="chart-wrap">
              <canvas id="growthChart" width="400" height="260"></canvas>
              <div style="font-size:12px;color:var(--muted);margin-top:10px;text-align:center">Patrim√¥nio Nominal e Real (Linha)</div>
            </div>
            <hr style="border-color:var(--subtle-border);margin:15px 0" />

            <div class="chart-wrap bar-chart-container">
              <canvas id="barChart" width="400" height="200"></canvas>
              <div style="font-size:12px;color:var(--muted);margin-top:10px;text-align:center">Patrim√¥nio Acumulado vs. IR Total (Barra)</div>
            </div>
            
            <div id="projectionSummary" style="margin-top:12px;padding:12px;background:var(--highlight-bg);border-radius:8px;font-size:13px"></div>
          </div>

          <div id="monthly-tab" class="tab-content">
            <div style="overflow-x:auto">
              <table class="projection-table">
                <thead>
                  <tr>
                    <th>M√™s</th>
                    <th class="right">Patrim√¥nio</th>
                    <th class="right">Aporte</th>
                    <th class="right">Proventos Brutos</th>
                    <th class="right">IR</th>
                    <th class="right">Proventos L√≠q.</th>
                  </tr>
                </thead>
                <tbody id="monthlyProjectionBody"></tbody>
              </table>
            </div>
            <div style="margin-top:10px;padding:10px;background:rgba(16,185,129,0.1);border-radius:6px;font-size:12px" id="monthlyStats"></div>
          </div>
        </section>

        <section class="card">
          <h3>üí° Informa√ß√µes sobre IR</h3>
          <ul class="muted small" style="padding-left:20px">
            <li>**FIIs e A√ß√µes (Dividendos):** Proventos s√£o tratados como isentos no c√°lculo anual.</li>
            <li>**Renda Fixa:** Al√≠quota regressiva de 22,5% a 15% conforme a dura√ß√£o em dias informada.</li>
            <li>**Renda Recorrente (99Pay):** O IR √© simulado com a al√≠quota informada (padr√£o 20%).</li>
            <li>**Renda Kwai/Outras:** Tratada como l√≠quido, sem c√°lculo de IR pelo simulador.</li>
          </ul>
        </section>
      </aside>
    </div>

    <div class="footer">
      <strong>Simulador Avan√ßado de Investimentos</strong> ‚Äî Ferramenta educacional para planejamento financeiro.
    </div>
  </div>

  <script>
    const $ = id => document.getElementById(id)
    const currency = v => 'R$ ' + Number(v).toLocaleString('pt-BR', {minimumFractionDigits:2, maximumFractionDigits:2})
    
    let assets = []
    let recurrentIncomes = [] // Nova vari√°vel para armazenar rendas recorrentes
    let filterCategory = ''
    let editingIndex = -1 
    
    const tbody = document.querySelector('#assetsTable tbody')
    const recurrentTbody = document.querySelector('#recurrentIncomeTable tbody')
    
    // Elementos do Dashboard da Carteira
    const totalInvestEl = $('totalInvest')
    const totalYieldEl = $('totalYield')
    const totalIREl = $('totalIR')
    const netYieldEl = $('netYield')
    const avgYieldEl = $('avgYield')
    const totalAssetsEl = $('totalAssets')
    const rfDurationRow = $('rfDurationRow')
    const isExemptRow = $('isExemptRow')
    const categoryNetStatsEl = $('categoryNetStats')

    // Elementos dos Cards de Proje√ß√£o
    const projectedGrossYieldEl = $('projectedGrossYield')
    const projectedIRPaidEl = $('projectedIRPaid')
    const projectedNetYieldEl = $('projectedNetYield')

    /*
     * L√≥gica de Tributa√ß√£o
     */
    function calculateIR(income, category, irExempt, daysHeld) {
      if (irExempt || category === 'FII' || category === 'A√ß√µes') return 0
      
      let rate = 0.15 

      if (category === 'Renda Fixa' && daysHeld > 0) {
        if (daysHeld <= 180) rate = 0.225
        else if (daysHeld <= 360) rate = 0.20
        else if (daysHeld <= 720) rate = 0.175
        else rate = 0.15
      }

      return income * rate
    }

    // Fun√ß√£o para calcular o provento l√≠quido anual de um ativo
    function getAssetNetProvento(a) {
        const invested = a.qty * a.price
        const provento = invested * (a.yield/100)
        const ir = calculateIR(provento, a.category, a.irExempt, a.daysHeld)
        return provento - ir
    }

    // Fun√ß√£o para calcular o rendimento l√≠quido anual de uma renda recorrente
    function getRecurrentNetProvento(r) {
        if (r.type === '99Pay') {
            const daysInMonth = 30.41;
            const grossMonthly = r.value; // Aqui, o 'value' √© o ganho di√°rio (0.15), n√£o mensal. Vamos ajustar a l√≥gica para refletir o input atual.
            // NOVO MODELO: O input 'value' √© o valor mensal
            const irRate = r.irRate / 100;
            const irMonthly = r.value * irRate;
            return (r.value - irMonthly) * 12;
        }
        // Para Kwai e Outra Renda L√≠quida
        return r.value * 12;
    }
    
    // Calcula o valor l√≠quido ANUAL de uma renda recorrente
    function calculateRecurrentNetAnnual(type, monthlyValue, irRate) {
        if (type === '99Pay') {
            const ir = monthlyValue * (irRate / 100);
            return (monthlyValue - ir) * 12;
        }
        return monthlyValue * 12; // L√≠quido
    }

    $('category').addEventListener('change', (e) => {
      const category = e.target.value
      if (category === 'Renda Fixa') {
        rfDurationRow.style.display = 'flex'
      } else {
        rfDurationRow.style.display = 'none'
      }
      isExemptRow.style.display = 'block'
    })
    
    // --- L√≥gica de Rendas Recorrentes ---
    function renderRecurrentTable() {
        recurrentTbody.innerHTML = '';
        let totalNetAnnual = 0;
        
        recurrentIncomes.forEach((r, index) => {
            const typeText = r.type === '99Pay' ? '99Pay/MP (Mensal Bruto)' : r.type;
            const irText = r.type === '99Pay' ? `${r.irRate}%` : '0%';
            const netAnnual = calculateRecurrentNetAnnual(r.type, r.value, r.irRate);
            totalNetAnnual += netAnnual;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><strong>${typeText}</strong></td>
                <td class="right">${currency(r.value)}</td>
                <td class="right">${irText}</td>
                <td class="right">${currency(netAnnual)}</td>
                <td>
                    <button class="small-btn" onclick="deleteRecurrent(${index})">üóëÔ∏è</button>
                </td>
            `;
            recurrentTbody.appendChild(tr);
        });
        
        $('totalRecurrentIncome').textContent = `Total L√≠quido Anual de Rendas Recorrentes: ${currency(totalNetAnnual)}`;
        drawCharts();
    }
    
    $('addRecurrentBtn').addEventListener('click', () => {
        const type = $('recurrentIncomeType').value;
        const value = Number($('recurrentMonthlyValue').value);
        const irRate = Number($('recurrentIrRate').value);

        if (value <= 0) return alert('O valor mensal deve ser maior que zero.');

        // O input 'value' agora representa o valor BRUTO/L√çQUIDO mensal, n√£o o di√°rio.
        const newRecurrent = {
            type,
            value,
            irRate: type === '99Pay' ? irRate : 0, // IR s√≥ √© relevante para 99Pay/MP
        };
        
        recurrentIncomes.push(newRecurrent);
        renderRecurrentTable();
        
        // Resetar formul√°rio ap√≥s adi√ß√£o
        $('recurrentMonthlyValue').value = '50.00';
        $('recurrentIrRate').value = '20';
        $('recurrentIncomeType').value = 'Kwai';
    });

    window.deleteRecurrent = function(index) {
        if (confirm('Remover esta renda recorrente?')) {
            recurrentIncomes.splice(index, 1);
            renderRecurrentTable();
        }
    }
    // --- Fim L√≥gica de Rendas Recorrentes ---
    
    function renderCategoryNetStats() {
        const categories = {}
        let totalNetAnnual = 0;
        
        // 1. Coletar dados dos ativos
        assets.forEach(a => {
            const category = a.category;
            const invested = a.qty * a.price;
            const netProvento = getAssetNetProvento(a);
            
            if (!categories[category]) {
                categories[category] = { invested: 0, netYield: 0, isExternal: false };
            }
            categories[category].invested += invested;
            categories[category].netYield += netProvento;
            totalNetAnnual += netProvento;
        });

        // 2. Adicionar Rendas Recorrentes
        recurrentIncomes.forEach((r, index) => {
            const netAnnual = calculateRecurrentNetAnnual(r.type, r.value, r.irRate);
            const key = `Renda_${r.type}_${index}`; // Chave √∫nica para evitar colis√£o
            
            categories[key] = {
                invested: 0, 
                netYield: netAnnual, 
                isExternal: true, 
                type: r.type,
                irRate: r.irRate
            };
            totalNetAnnual += netAnnual;
        });
        
        // 3. Adicionar Card Total
        categories['TOTAL_GERAL'] = {
            invested: assets.reduce((s,a)=>s + a.qty*a.price, 0),
            netYield: totalNetAnnual,
            isExternal: 'total',
            label: 'Total L√≠quido Anual'
        };

        // 4. Renderizar Cards
        let html = '';
        
        Object.entries(categories).forEach(([key, data]) => {
            if (key === 'TOTAL_GERAL') return; // Renderiza o total por √∫ltimo

            const isExternal = data.isExternal;
            let title, description, classType = '';

            if (isExternal) {
                classType = 'external-yield';
                title = data.type === '99Pay' ? '99Pay/MP (L√≠q)' : data.type;
                description = data.type === '99Pay' ? `IR ${data.irRate}%` : 'Renda L√≠quida Mensal';
            } else {
                title = key;
                description = `Patrim√¥nio: ${currency(data.invested)}`;
            }

            html += `
                <div class="category-stat-card ${classType}">
                    <div class="muted small">Ganho L√≠quido Anual (${title})</div>
                    <div class="stat-value">${currency(data.netYield)}</div>
                    <div class="muted small">${description}</div>
                </div>
            `;
        });
        
        // Renderizar Card Total
        const totalData = categories['TOTAL_GERAL'];
        html += `
            <div class="category-stat-card total-yield">
                <div class="muted small">${totalData.label}</div>
                <div class="stat-value">${currency(totalData.netYield)}</div>
                <div class="muted small">Investido Total: ${currency(totalData.invested)}</div>
            </div>
        `;

        categoryNetStatsEl.innerHTML = html;
    }
    
    function renderTable() {
      tbody.innerHTML = ''
      
      const allInvest = assets.reduce((s,a)=>s+a.qty*a.price,0)
      let allYield = 0, allIR = 0
      
      assets.forEach(a => {
        const invested = a.qty * a.price
        const provento = invested * (a.yield/100)
        const ir = calculateIR(provento, a.category, a.irExempt, a.daysHeld)
        
        allYield += provento
        allIR += ir
      })

      const filteredAssets = filterCategory ? assets.filter(a => a.category === filterCategory) : assets
      
      filteredAssets.forEach((a) => {
        const invested = a.qty * a.price
        const provento = invested * (a.yield/100)
        const ir = calculateIR(provento, a.category, a.irExempt, a.daysHeld)
        const percentage = allInvest ? (invested / allInvest * 100) : 0
        
        const isExemptByRule = a.category === 'FII' || a.category === 'A√ß√µes' || a.irExempt;
        const irClass = isExemptByRule ? 'ir-exempt' : 'ir-warning'
        const irText = isExemptByRule ? 'Isento' : currency(ir)
        
        const tr = document.createElement('tr')
        tr.innerHTML = `
          <td><strong>${a.symbol}</strong></td>
          <td><span class="badge">${a.category}</span></td>
          <td class="right">${a.qty}</td>
          <td class="right small">${a.purchaseDate}</td>
          <td class="right">${currency(invested)}</td>
          <td class="right">${percentage.toFixed(1)}%</td>
          <td class="right">${a.yield.toFixed(2)}%</td>
          <td class="right">${currency(provento)}</td>
          <td class="right ${irClass}">${irText}</td>
          <td>
            <button class="small-btn" onclick="editAsset(${assets.indexOf(a)})">‚úèÔ∏è</button>
            <button class="small-btn" onclick="deleteAsset(${assets.indexOf(a)})">üóëÔ∏è</button>
          </td>
        `
        tbody.appendChild(tr)
      })
      
      const netYield = allYield - allIR
      const avgYield = allInvest > 0 ? (netYield / allInvest * 100) : 0
      
      totalInvestEl.textContent = currency(allInvest)
      totalYieldEl.textContent = currency(allYield)
      totalIREl.textContent = currency(allIR)
      netYieldEl.textContent = currency(netYield) // Apenas ativos
      avgYieldEl.textContent = avgYield.toFixed(2) + '%'
      totalAssetsEl.textContent = assets.length
      
      drawCharts()
      renderCategoryNetStats(); // Atualiza os cards de categorias
    }
    
    // Fun√ß√£o unificada para Adicionar e Atualizar
    function processAsset() {
      const symbol = $('symbol').value.trim().toUpperCase()
      const qty = $('qty').value
      const price = $('price').value
      const yieldPerc = $('yield').value
      const category = $('category').value
      const irExempt = $('irExempt').checked
      const daysHeld = $('daysHeld').value
      const purchaseDate = $('purchaseDate').value

      if(!symbol) return alert('Preencha o s√≠mbolo')
      if(Number(qty) <= 0 || Number(price) <= 0) return alert('Quantidade e Pre√ßo devem ser maiores que zero.')

      const newAsset = {
        symbol, 
        qty:Number(qty), 
        price:Number(price), 
        yield:Number(yieldPerc), 
        category: category || 'Outros',
        irExempt: Boolean(irExempt),
        daysHeld: category === 'Renda Fixa' ? Number(daysHeld) : 0,
        purchaseDate: purchaseDate // Salva a data de aquisi√ß√£o
      }
      
      if(editingIndex !== -1) {
        assets[editingIndex] = newAsset 
      } else {
        assets.push(newAsset)
      }

      renderTable()
      resetForm()
    }
    
    function resetForm() {
      $('symbol').value=''; $('qty').value=1; $('price').value=10.00; $('yield').value=10.00; 
      $('category').value='FII'; $('irExempt').checked=false; $('daysHeld').value=721;
      $('purchaseDate').value = new Date().toISOString().split('T')[0];
      
      editingIndex = -1
      $('addBtn').style.display = 'block'
      $('updateBtn').style.display = 'none'
      $('assetFormTitle').textContent = '‚ûï Adicionar Ativo / Fundo'
      
      $('category').dispatchEvent(new Event('change'))
    }
    
    function editAsset(index) {
      const a = assets[index]
      
      $('symbol').value = a.symbol
      $('qty').value = a.qty
      $('price').value = a.price
      $('yield').value = a.yield
      $('category').value = a.category
      $('irExempt').checked = a.irExempt
      $('daysHeld').value = a.daysHeld || 721
      $('purchaseDate').value = a.purchaseDate || new Date().toISOString().split('T')[0];
      
      $('category').dispatchEvent(new Event('change'))

      $('addBtn').style.display = 'none'
      $('updateBtn').style.display = 'block'
      $('assetFormTitle').textContent = `‚úèÔ∏è Editando: ${a.symbol}`
      editingIndex = index
    }
    
    function deleteAsset(index) {
      if(confirm(`Remover ${assets[index].symbol}?`)){
        assets.splice(index, 1)
        renderTable()
        resetForm()
      }
    }
    
    window.editAsset = editAsset
    window.deleteAsset = deleteAsset
    
    $('addBtn').addEventListener('click', processAsset)
    $('updateBtn').addEventListener('click', processAsset)
    
    $('presetBtn').addEventListener('click', ()=>{
      resetForm() 
      assets.push({symbol: 'RZAG11', qty: 2, price: 9.00, yield: 16.4, category: 'FII', irExempt: true, daysHeld: 0, purchaseDate: '2023-11-01'})
      assets.push({symbol: 'MXRF11', qty: 1, price: 9.61, yield: 12.7, category: 'FII', irExempt: true, daysHeld: 0, purchaseDate: '2024-01-15'})
      assets.push({symbol: 'VSLH11', qty: 4, price: 2.50, yield: 13.8, category: 'FII', irExempt: true, daysHeld: 0, purchaseDate: '2024-05-20'})
      recurrentIncomes.push({ type: 'Kwai', value: 150.00, irRate: 0 })
      recurrentIncomes.push({ type: '99Pay', value: 300.00, irRate: 20 })

      renderTable()
      renderRecurrentTable();
      resetForm()
    })
    
    $('clearBtn').addEventListener('click', ()=>{
      if(confirm('Remover TODOS os ativos e rendas recorrentes? Esta a√ß√£o n√£o pode ser desfeita.')){ 
        assets = []
        recurrentIncomes = []
        renderTable() 
        renderRecurrentTable()
        resetForm()
      }
    })
    
    $('saveBtn').addEventListener('click', ()=>{
      localStorage.setItem('simulator_assets', JSON.stringify(assets))
      localStorage.setItem('simulator_recurrent', JSON.stringify(recurrentIncomes))
      alert('‚úÖ Carteira e Rendas salvas no navegador com sucesso!')
    })
    
    $('resetStorage').addEventListener('click', ()=>{ 
      if(confirm('Apagar dados salvos permanentemente?')){
        localStorage.removeItem('simulator_assets')
        localStorage.removeItem('simulator_recurrent')
        localStorage.removeItem('theme') 
        assets = []
        recurrentIncomes = []
        renderTable()
        renderRecurrentTable()
        resetForm()
        alert('‚úÖ Dados apagados com sucesso')
      }
    })
    
    function loadSaved(){
      const rawAssets = localStorage.getItem('simulator_assets')
      if(rawAssets){ 
        assets = JSON.parse(rawAssets)
      }
      const rawRecurrent = localStorage.getItem('simulator_recurrent')
      if(rawRecurrent){ 
        recurrentIncomes = JSON.parse(rawRecurrent)
      }
      renderTable()
      renderRecurrentTable()
    }
    loadSaved()
    
    $('exportBtn').addEventListener('click', ()=>{
      if(assets.length===0 && recurrentIncomes.length===0) return alert('Nenhum dado para exportar')

      let csv = 'Simulador de Investimentos - Export\n\n'
      
      // Exportar Ativos
      csv += 'Carteira de Ativos\n'
      const assetRows = [['symbol','category','qty','price','yield','irExempt','daysHeld','purchaseDate']]
      assets.forEach(a=>assetRows.push([a.symbol,a.category,a.qty,a.price,a.yield,a.irExempt,a.daysHeld || 0, a.purchaseDate || 'N/A']))
      csv += assetRows.map(r=>r.join(',')).join('\n') + '\n\n'

      // Exportar Rendas Recorrentes
      csv += 'Rendas Recorrentes\n'
      const recurrentRows = [['type','monthly_value','ir_rate']]
      recurrentIncomes.forEach(r=>recurrentRows.push([r.type, r.value, r.irRate]))
      csv += recurrentRows.map(r=>r.join(',')).join('\n')

      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'})
      const url = URL.createObjectURL(blob)
      const link = document.createElement('a')
      link.href = url
      link.download = 'carteira_completa_' + new Date().toISOString().split('T')[0] + '.csv'
      link.click()
      URL.revokeObjectURL(url)
    })
    
    $('importBtn').addEventListener('click', ()=> $('importFile').click())
    $('importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0]
      if(!file) return
      const reader = new FileReader()
      reader.onload = (ev)=>{
        const text = ev.target.result
        const lines = text.split('\n')
        
        let inAssets = false
        let inRecurrent = false
        assets = []
        recurrentIncomes = []

        lines.forEach(line=>{
            line = line.trim()
            if (!line) return;

            if (line === 'Carteira de Ativos') {
                inAssets = true
                inRecurrent = false
                return
            } else if (line === 'Rendas Recorrentes') {
                inAssets = false
                inRecurrent = true
                return
            } else if (line.startsWith('symbol') || line.startsWith('type')) {
                // Skip header
                return
            }

            const values = line.split(',')

            if (inAssets && values.length >= 8) {
                const [symbol,category,qty,price,yieldVal,irExempt,daysHeld,purchaseDate] = values
                if(symbol && symbol.trim()) {
                    assets.push({
                      symbol: symbol.trim(), 
                      qty: Number(qty), 
                      price: Number(price), 
                      yield: Number(yieldVal), 
                      category: category,
                      irExempt: irExempt === 'true',
                      daysHeld: Number(daysHeld) || 0,
                      purchaseDate: purchaseDate || 'N/A'
                    });
                }
            } else if (inRecurrent && values.length === 3) {
                const [type, monthlyValue, irRate] = values
                recurrentIncomes.push({
                    type: type,
                    value: Number(monthlyValue),
                    irRate: Number(irRate)
                });
            }
        })

        renderTable()
        renderRecurrentTable()
        alert('‚úÖ Carteira e Rendas importadas com sucesso!')
      }
      reader.readAsText(file)
      e.target.value = ''
    })
    
    $('filterCategory').addEventListener('change', (e)=>{
      filterCategory = e.target.value
      renderTable()
    })
    
    const chartCanvas = $('growthChart')
    const pieCanvas = $('pieChart')
    const barCanvas = $('barChart')

    function drawCharts(){
      drawGrowthChart()
      drawPieChart()
      drawMonthlyProjection()
      drawBarChart()
      renderCategoryNetStats();
    }

    /*
     * GR√ÅFICO DE PATRIM√îNIO VS IR (Barras)
     */
    function drawBarChart() {
        const ctx = barCanvas.getContext('2d')
        ctx.clearRect(0, 0, barCanvas.width, barCanvas.height)
        
        const years = Number($('years').value)
        const monthlyAdd = Number($('monthlyContribution').value)
        const reinvest = $('reinvest').checked
        const totalInvest = assets.reduce((s,a)=>s + a.qty*a.price, 0)
        
        const weightedYield = assets.length && totalInvest > 0 ? 
            assets.reduce((s,a)=> s + getAssetNetProvento(a), 0) / totalInvest : 0
        
        let totalExternalNetMonthly = 0;
        let totalExternalIRMonthly = 0;

        recurrentIncomes.forEach(r => {
            if (r.type === '99Pay') {
                const irMonthly = r.value * (r.irRate / 100);
                totalExternalIRMonthly += irMonthly;
                totalExternalNetMonthly += r.value - irMonthly;
            } else {
                totalExternalNetMonthly += r.value;
            }
        });

        let value = totalInvest
        let totalIR = 0
        let barData = [] 

        for(let y=1; y<=years; y++){
            const yearlyContributions = monthlyAdd * 12
            
            let irYear = 0
            
            for(let m=1; m<=12; m++) {
                // Provento de Investimentos (Assume-se que o provento √© ponderado)
                const proventoBrutoInvest = value * weightedYield / 12
                // C√°lculo simplificado da parte do IR que o provento de ativos representa
                const irInvestimentos = (proventoBrutoInvest * (1 - (getAssetNetProvento({qty:1,price:1,yield:100*weightedYield,category:'Outros',irExempt:false,daysHeld:721}) / (100*weightedYield)))) || 0
                
                irYear += irInvestimentos + totalExternalIRMonthly
                
                const proventoNetTotal = (proventoBrutoInvest - irInvestimentos) + totalExternalNetMonthly;


                if(reinvest){ 
                  value += proventoNetTotal 
                } 
                
                value += monthlyAdd 
            }

            totalIR += irYear
            
            barData.push({
                year: y, 
                patrimony: value,
                ir: totalIR
            })
        }

        if(barData.length === 0) return

        // Desenho do Gr√°fico (simplificado)
        const W = barCanvas.width, H = barCanvas.height, PAD = 25
        const maxV = Math.max(...barData.map(d => d.patrimony))
        const barW = (W - 2 * PAD) / (years * 2.5) 

        const drawBar = (x, h, color) => {
            ctx.fillStyle = color
            ctx.fillRect(x, H - PAD - h, barW, h)
        }

        const hScale = (H - 2 * PAD) / maxV

        ctx.fillStyle = document.documentElement.getAttribute('data-theme') === 'dark' ? '#e6eef6' : '#1e293b'
        ctx.font='10px sans-serif'
        ctx.textAlign = 'center'
        
        barData.forEach((d, i) => {
            const x = PAD + i * (W - 2 * PAD) / years + barW/2
            const hPatrimony = d.patrimony * hScale
            const hIR = d.ir * hScale

            // Barra de Patrim√¥nio
            drawBar(x, hPatrimony, document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(6,182,212,0.8)' : 'rgba(29,78,216,0.8)')
            
            // Barra de IR
            drawBar(x + barW + 5, hIR, 'rgba(239, 68, 68, 0.8)') 

            // R√≥tulo do Ano
            ctx.fillText(`${d.year}¬∫ ano`, x + barW / 2, H - PAD + 15)
        })

        // Eixos
        ctx.strokeStyle = document.documentElement.getAttribute('data-theme') === 'dark' ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)'
        ctx.beginPath(); 
        ctx.moveTo(PAD, H-PAD); 
        ctx.lineTo(PAD, H-PAD); 
        ctx.lineTo(W-PAD, H-PAD); 
        ctx.stroke()
        
        ctx.textAlign = 'left'
        ctx.fillText(currency(maxV), 5, PAD)
        ctx.fillText('R$ 0,00', 5, H - PAD - 5)

    }

    function drawGrowthChart(){
      const ctx = chartCanvas.getContext('2d')
      ctx.clearRect(0,0,chartCanvas.width, chartCanvas.height)
      
      const years = Number($('years').value)
      const reinvest = $('reinvest').checked
      const monthlyAdd = Number($('monthlyContribution').value)
      const considerInflation = $('considerInflation').checked
      const inflationRate = 0.045
      
      let totalExternalNetMonthly = 0;
      recurrentIncomes.forEach(r => {
        const irMonthly = r.type === '99Pay' ? r.value * (r.irRate / 100) : 0;
        totalExternalNetMonthly += r.value - irMonthly;
      });

      const totalInvest = assets.reduce((s,a)=>s + a.qty*a.price, 0)
      
      const weightedYield = assets.length && totalInvest > 0 ? 
        assets.reduce((s,a)=> s + getAssetNetProvento(a), 0) / totalInvest : 0
      
      let points = []
      let value = totalInvest
      
      for(let y=0; y<=years; y++){
        let currentInflation = considerInflation ? Math.pow(1 + inflationRate, y) : 1
        points.push({ nominal: Number(value.toFixed(2)), real: Number((value / currentInflation).toFixed(2)) })
        
        const yearlyNetDividend = value * weightedYield
        const yearlyContributions = monthlyAdd * 12
        const yearlyExternalYieldNet = totalExternalNetMonthly * 12
        
        if(reinvest){ 
          value = value + yearlyNetDividend + yearlyContributions + yearlyExternalYieldNet
        } else { 
          value = value + yearlyContributions 
        }
      }
      
      // Desenho do Gr√°fico (Linhas - Omitido para brevidade)
      // ... L√≥gica de desenho de Linhas

      const finalValue = points[points.length-1].nominal
      const finalRealValue = points[points.length-1].real
      const totalContributions = totalInvest + (monthlyAdd * 12 * years)
      const totalGains = finalValue - totalContributions
      const gainsPct = totalContributions > 0 ? (totalGains/totalContributions*100) : 0
      
      $('projectionSummary').innerHTML = `
        <strong>üìä Proje√ß√£o para ${years} ano(s):</strong><br><br>
        <div style="display:grid;gap:6px">
          <div>üí∞ <strong>Valor final (Nominal):</strong> ${currency(finalValue)}</div>
          ${considerInflation ? `<div>üîª <strong>Valor final (Real):</strong> ${currency(finalRealValue)}</div>` : ''}
          <div>üíµ <strong>Total investido (Aportes + Inicial):</strong> ${currency(totalContributions)}</div>
          <div style="color:var(--success)">üìà <strong>Ganhos Nominais:</strong> ${currency(totalGains)} (${gainsPct.toFixed(1)}%)</div>
          <div>üìÖ <strong>Proventos l√≠quidos mensais (√∫ltimo ano):</strong> ${currency(totalExternalNetMonthly + (finalValue * weightedYield / 12))}</div>
          ${considerInflation ? `<div style="font-size:11px; color:var(--muted); margin-top:5px;">*O Valor Real desconta a infla√ß√£o (IPCA) projetada.</div>` : ''}
        </div>
      `
    }
    
    function drawMonthlyProjection() {
      const tbody = $('monthlyProjectionBody')
      tbody.innerHTML = ''
      
      const years = Number($('years').value)
      const reinvest = $('reinvest').checked
      const monthlyAdd = Number($('monthlyContribution').value)
      
      // C√°lculo das Rendas Recorrentes
      let totalExternalGrossMonthly = 0;
      let totalExternalIRMonthly = 0;
      let totalExternalNetMonthly = 0;

      recurrentIncomes.forEach(r => {
        let gross = r.value;
        let ir = 0;
        let net = gross;

        if (r.type === '99Pay') {
          ir = gross * (r.irRate / 100);
          net = gross - ir;
        } 
        
        totalExternalGrossMonthly += gross;
        totalExternalIRMonthly += ir;
        totalExternalNetMonthly += net;
      });

      const totalInvest = assets.reduce((s,a)=>s + a.qty*a.price, 0)
      
      let patrimony = totalInvest
      let totalProventosNet = 0 
      let totalGrossProventos = 0 
      let totalIRPaid = 0
      let totalAportes = totalInvest 
      
      const totalMonths = years * 12
      const showEvery = totalMonths > 60 ? 3 : 1
      
      for(let month = 1; month <= totalMonths; month++) {
        
        let grossProventoInvest = 0;
        let monthlyIRInvest = 0;

        if(totalInvest > 0) {
            assets.forEach(a => {
                // C√°lculo proporcional do rendimento do ativo no patrim√¥nio total
                const assetProportion = (a.qty * a.price) / totalInvest;
                const assetInvestedInMonth = patrimony * assetProportion;
                
                const assetProvento = (assetInvestedInMonth * (a.yield/100) / 12)
                const assetIR = calculateIR(assetProvento, a.category, a.irExempt, a.daysHeld);
                
                grossProventoInvest += assetProvento;
                monthlyIRInvest += assetIR;
            });
        }
        
        // Inclui Rendas Recorrentes
        const grossProventoTotal = grossProventoInvest + totalExternalGrossMonthly
        const monthlyIRTotal = monthlyIRInvest + totalExternalIRMonthly
        const monthlyProventoNet = grossProventoTotal - monthlyIRTotal 

        patrimony += monthlyAdd
        if(month > 0) { 
          totalAportes += monthlyAdd
        }
        
        if(reinvest) {
          patrimony += monthlyProventoNet
        }
        
        totalProventosNet += monthlyProventoNet
        totalGrossProventos += grossProventoTotal
        totalIRPaid += monthlyIRTotal
        
        if(month % showEvery === 0 || month === totalMonths) {
          const tr = document.createElement('tr')
          const isHighlight = month % 12 === 0 ? ' class="highlight"' : ''
          tr.innerHTML = `
            <td${isHighlight}>${month}</td>
            <td class="right"${isHighlight}>${currency(patrimony)}</td>
            <td class="right"${isHighlight}>${currency(monthlyAdd)}</td>
            <td class="right"${isHighlight}>${currency(grossProventoTotal)}</td>
            <td class="right ${monthlyIRTotal > 0 ? 'ir-warning' : 'ir-exempt'}"${isHighlight}>${currency(monthlyIRTotal)}</td>
            <td class="right ${monthlyProventoNet > 0 ? 'ir-exempt' : ''}"${isHighlight}>${currency(monthlyProventoNet)}</td>
          `
          tbody.appendChild(tr)
        }
      }
      
      const totalGains = patrimony - totalAportes

      // Atualiza os novos Cards de Proje√ß√£o (Inclui Rendas Recorrentes no total projetado)
      projectedGrossYieldEl.textContent = currency(totalGrossProventos)
      projectedIRPaidEl.textContent = currency(totalIRPaid)
      projectedNetYieldEl.textContent = currency(totalProventosNet)

      $('monthlyStats').innerHTML = `
        <strong>üìä Resumo acumulado (${years} anos):</strong><br>
        Total de aportes (inicial + mensais): ${currency(totalAportes)} | 
        Proventos brutos: ${currency(totalGrossProventos)} |
        Proventos l√≠quidos: ${currency(totalProventosNet)} | 
        IR pago: ${currency(totalIRPaid)} |
        Patrim√¥nio final: ${currency(patrimony)} |
        Ganhos Totais: ${currency(totalGains)}
      `
    }

    function drawPieChart(){
      const ctx = pieCanvas.getContext('2d')
      ctx.clearRect(0,0,pieCanvas.width, pieCanvas.height)
      
      if(assets.length === 0) {
        ctx.fillStyle = document.documentElement.getAttribute('data-theme') === 'dark' ? '#94a3b8' : '#64748b'
        ctx.font = '14px sans-serif'
        ctx.textAlign = 'center'
        ctx.fillText('Adicione ativos para visualizar', pieCanvas.width/2, pieCanvas.height/2)
        $('categoryBreakdown').innerHTML = '<div class="muted small">Nenhum ativo adicionado</div>'
        return
      }
      
      const categories = {}
      const totalInvest = assets.reduce((s,a)=>s+a.qty*a.price,0)
      assets.forEach(a=>{
        const inv = a.qty * a.price
        categories[a.category] = (categories[a.category]||0) + inv
      })
      
      const colors = ['#06b6d4','#8b5cf6','#f59e0b','#10b981','#ef4444','#ec4899','#6366f1','#14b8a6']
      let startAngle = -Math.PI/2
      const centerX = pieCanvas.width/2, centerY = pieCanvas.height/2 - 10, radius = 80
      
      Object.entries(categories).forEach(([cat,val], i)=>{
        const sliceAngle = (val/totalInvest) * 2 * Math.PI
        ctx.beginPath()
        ctx.moveTo(centerX, centerY)
        ctx.arc(centerX, centerY, radius, startAngle, startAngle + sliceAngle)
        ctx.closePath()
        ctx.fillStyle = colors[i % colors.length]
        ctx.fill()
        ctx.strokeStyle = document.documentElement.getAttribute('data-theme') === 'dark' ? '#0b1220' : '#ffffff'
        ctx.lineWidth = 2
        ctx.stroke()
        startAngle += sliceAngle
      })
      
      const breakdown = $('categoryBreakdown')
      breakdown.innerHTML = '<div style="display:grid;gap:6px">' + 
        Object.entries(categories).map(([cat,val],i)=>{
          const pct = (val/totalInvest*100).toFixed(1)
          return `<div style="display:flex;align-items:center;gap:10px">
            <div style="width:16px;height:16px;background:${colors[i%colors.length]};border-radius:3px"></div>
            <span><strong>${cat}:</strong> ${currency(val)} (${pct}%)</span>
          </div>`
        }).join('') + '</div>'
    }
    
    // --- L√≥gica de Tema ---
    const themeToggle = $('themeToggle')
    const html = document.documentElement

    function loadTheme() {
        const savedTheme = localStorage.getItem('theme') || 'dark'
        html.setAttribute('data-theme', savedTheme)
    }

    function toggleTheme() {
        const currentTheme = html.getAttribute('data-theme')
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark'
        html.setAttribute('data-theme', newTheme)
        localStorage.setItem('theme', newTheme)
        drawCharts() 
    }

    themeToggle.addEventListener('click', toggleTheme)
    loadTheme()
    // --- Fim L√≥gica de Tema ---

    $('years').addEventListener('change', drawCharts)
    $('reinvest').addEventListener('change', drawCharts)
    $('monthlyContribution').addEventListener('input', drawCharts)
    $('considerInflation').addEventListener('change', drawCharts)

    // Qualquer mudan√ßa nas rendas recorrentes deve chamar drawCharts
    $('recurrentIncomeTable').addEventListener('DOMSubtreeModified', drawCharts);
    
    function resizeCanvas(){ 
      chartCanvas.width = Math.min(380, window.innerWidth*0.4)
      chartCanvas.height = 260
      pieCanvas.width = Math.min(360, window.innerWidth*0.35)
      pieCanvas.height = 220
      barCanvas.width = Math.min(380, window.innerWidth*0.4)
      barCanvas.height = 200
      drawCharts() 
    }
    window.addEventListener('resize', resizeCanvas)
    resizeCanvas()
    
    $('category').dispatchEvent(new Event('change'))
    resetForm(); // Garante que a data de aquisi√ß√£o inicial seja preenchida

    function switchTab(tab) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'))
      
      if(tab === 'growth') {
        document.querySelector('.tab:nth-child(1)').classList.add('active')
        $('growth-tab').classList.add('active')
      } else {
        document.querySelector('.tab:nth-child(2)').classList.add('active')
        $('monthly-tab').classList.add('active')
      }
    }
    
    window.switchTab = switchTab
    
    // Chamada inicial (agora feita em loadSaved)
    // renderTable()
  </script>
</body>
</html>
